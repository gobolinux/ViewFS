#!/bin/sh

if ! [ "$1" ]
then
   echo "Usage: $0 file.c"
   exit 1
fi

while [ "$1" ]
do

cfile="$1"
cbase=$(basename "$cfile" .c)
hfile=$(dirname $cfile)/"$cbase.h"

gawk -v base="$cbase" '

   BEGIN {
      print "/* Do not edit this file. It was automatically generated. */"
      print "#ifndef HEADER_" base
      print "#define HEADER_" base
      print ""
   }

   # Other lines: skip unless it is a continuation.
   {
      if (follow > 0) {
         if (follow == 1) follow = 0
         print
      }
   }

   # Repeat includes and defines
   /^#.*/ {
      if ($1 == "#define") print ""
      print
      follow = (substr($0,length()) == "\\")
   }

   # Copy doxygen documentation
   /^\/\*\*$/ {
      follow = 2
      print ""
      print
   }
   /^ \*\/$/ {
      follow = 0
   }

   # Copy typedefs
   # Output prototypes for public functions
   /^[^ ].*{$/ {
      if ($1 == "typedef") {
         print ""
         print
         follow = 2
      } else if ($1 != "static") {
         sub(" {$", ";")
         print ""
         print
      }
   }
   /^}.*$/ {
      follow = 0
   }

   END {
      print ""
      print "#endif /* HEADER_" base " */"
   }

' < "$cfile" > "$hfile"

echo "$cfile => $hfile"

shift
done
